{% extends "baseadmin.html" %}

{% block title %}Lista de Usuarios{% endblock title %}

{% block body %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<ul class=flashes>
  {% for category, message in messages %}
  <script>
    (function(){
      if (!window.Swal) return;
      const Toast = Swal.mixin({ toast:true, position:"top-end", showConfirmButton:false, timer:2000, timerProgressBar:true });
      Toast.fire({ icon: "success", title: "{{ message }}" });
    })();
  </script>
  {% endfor %}
</ul>
{% endif %}
{% endwith %}

<style>
  body{background:linear-gradient(160deg,#0e0e10,#161618 55%,#1c1c1f);}
  .section-band{
    background:#1f1f21; border:1px solid #2a2a2a; color:#fff; border-radius:16px;
    box-shadow:0 10px 30px -12px rgba(0,0,0,.6);
  }
  .admin-table{
    background:#1f1f21; border:1px solid #2a2a2a; border-radius:18px; overflow:hidden;
    box-shadow:0 16px 34px -14px rgba(0,0,0,.45);
  }
  .admin-table .table thead th{
    background:linear-gradient(90deg,#7a0000,#c40000); color:#fff; border:none;
  }
  .admin-table .table tbody tr{ background:#1f1f21; color:#e6e6e6; }
  .admin-table .table tbody tr:hover{ background:#262628; }
  .admin-table .table td, .admin-table .table th{ border-color:#2a2a2a !important; }
  .dark-card{
    background:#1f1f21; border:1px solid #2a2a2a; border-radius:16px; color:#e6e6e6;
  }
  .dark-card .form-control{
    background:#232325; border:1px solid #2d2d2d; color:#e6e6e6; height:44px;
  }
  .dark-card .form-control::placeholder{ color:#a9a9ad; }
  .dark-card .form-control:focus{
    background:#252527; color:#fff; border-color:#c40000; box-shadow:0 0 0 .15rem rgba(196,0,0,.3);
  }
  .btn-primary{
    background:linear-gradient(90deg,#7a0000,#c40000); border:none; color:#fff; font-weight:600;
    box-shadow:0 6px 16px -8px rgba(110,0,0,.55);
  }
  .btn-primary:hover{ background:linear-gradient(90deg,#c40000,#ff4d4d); }
  .btn-outline-light{
    border-color:#ff4d4d; color:#ff4d4d;
  }
  .btn-outline-light:hover{ background:#ff4d4d; color:#111; border-color:#ff4d4d; }
  .secure-text{ -webkit-text-security: disc; text-security:disc; }
  .modal-content{ background:#1f1f21; color:#e6e6e6; border:1px solid #2a2a2a; }
  .modal-header{ background:linear-gradient(90deg,#7a0000,#c40000); color:#fff; border-bottom:none; }
  .modal-footer{ border-top:1px solid #2a2a2a; }
  .modal .form-control{
    background:#232325; border:1px solid #2d2d2d; color:#e6e6e6;
  }
  .modal .form-control:focus{
    background:#252527; color:#fff; border-color:#c40000; box-shadow:0 0 0 .15rem rgba(196,0,0,.3);
  }
</style>

<script>
  function confirmarEliminacion(url) {
    if (!window.Swal) { window.location.href = url; return; }
    Swal.fire({
      title: '¿Estás seguro?',
      text: 'Esta acción no se puede deshacer.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((r)=>{ if(r.isConfirmed) window.location.href=url; });
  }
  function toggleForm() {
    const form = document.getElementById('formAgregar');
    form.classList.toggle('d-none');
  }
</script>

<div class="container mt-4">
  <div class="section-band p-4 mb-4 d-flex align-items-center justify-content-between">
    <h3 class="m-0">Usuarios</h3>
    <button class="btn btn-primary" onclick="toggleForm()">Agregar usuario</button>
  </div>

  <div id="formAgregar" class="dark-card p-3 mb-4 d-none">
    <form method="POST" action="{{ url_for('agregar_usuario') }}">
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" name="nombre" class="form-control" placeholder="Nombre" required>
        </div>
        <div class="col-md-4">
          <input type="email" name="email" class="form-control" placeholder="Correo" required>
        </div>
        <div class="col-md-4">
          <div class="d-flex gap-2">
            <input type="text" name="password" class="form-control" placeholder="Contraseña" required>
            <button type="submit" class="btn btn-primary">Guardar</button>
            <button type="button" class="btn btn-outline-light" onclick="toggleForm()">Cancelar</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div class="admin-table p-3">
    <div class="table-responsive">
      <table class="table table-hover table-borderless align-middle mb-0">
        <thead>
          <tr>
            <th style="width:60px">N°</th>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Password</th>
            <th style="width:180px">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for usuario in usuarios %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ usuario.nombre }}</td>
            <td>{{ usuario.email }}</td>
            <td class="secure-text">{{ usuario.password }}</td>
            <td>
              <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditar{{ usuario.id }}">Editar</button>
                <a href="#" class="btn btn-outline-light btn-sm"
                   onclick="confirmarEliminacion('{{ url_for('eliminar_usuario', id=usuario.id) }}'); return false;">
                  Eliminar
                </a>
              </div>
            </td>
          </tr>

          <div class="modal fade" id="modalEditar{{ usuario.id }}" tabindex="-1" aria-labelledby="modalLabel{{ usuario.id }}" aria-hidden="true">
            <div class="modal-dialog">
              <form method="POST" action="{{ url_for('editar_usuario_modal', id=usuario.id) }}">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel{{ usuario.id }}">Editar Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="form-label">Nombre</label>
                      <input type="text" name="nombre" class="form-control" value="{{ usuario.nombre }}" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Correo</label>
                      <input type="email" name="email" class="form-control" value="{{ usuario.email }}" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Contraseña</label>
                      <input type="text" name="password" class="form-control secure-text" value="{{ usuario.password }}" required>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Botones al final -->
  <div class="text-center my-4">
    <div class="d-inline-flex gap-3">
      <a href="{{ url_for('perfil_admin') }}" class="btn btn-primary">Editar Perfil</a>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-light">Cerrar Sesión</a>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.all.min.js"></script>
{% endblock %}